<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate AI Trading Bot v2</title>
<style>
    body{background:#020617;color:white;font-family:Arial;text-align:center;margin:0;padding:20px}
    select,button,input{padding:10px;margin:5px;border-radius:8px;border:none;background:#1e293b;color:white;cursor:pointer}
    button:hover{background:#334155}
    canvas{background:#020617;border:1px solid #334155;margin-top:10px;display:block;margin-left:auto;margin-right:auto}
    .stats-container{display:flex;justify-content:center;gap:20px;margin:15px;font-weight:bold}
    .green{color:#22c55e}
    .red{color:#ef4444}
    #panel{background:#0f172a;padding:15px;border-radius:12px;display:inline-block;min-width:600px}
</style>
</head>
<body>

<h2>ULTIMATE AI TRADING BOT (RSI + ATR + TRAILING)</h2>

<div id="controls">
    Pair <select id="symbol">
        <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
    </select>
    TF <select id="tf">
        <option value="1m">1m</option><option value="5m">5m</option><option value="15m">15m</option>
    </select>
    Risk % <input type="range" min="1" max="5" value="2" id="risk">
    <button onclick="start()" style="background:#22c55e">START BOT</button>
    <button onclick="stop()" style="background:#ef4444">STOP BOT</button>
</div>

<div id="panel">
    <div class="stats-container">
        <div>Balance: $<span id="bal-val">10000</span></div>
        <div>Win Rate: <span id="wr-val">0</span>%</div>
        <div>Status: <span id="status-val">IDLE</span></div>
    </div>
    <div id="log-val" style="font-size:0.9em;color:#94a3b8">Waiting for start...</div>
</div>

<canvas id="chart" width="900" height="300"></canvas>
<canvas id="equity" width="900" height="100"></canvas>

<script>
let run = false, balance = 10000, pos = null, wins = 0, loss = 0, equity = [10000];

//---------------- INDICATORS
const ema = (a, p) => {
    let k = 2/(p+1), e = a[0];
    for(let i=1; i<a.length; i++) e = a[i]*k + e*(1-k);
    return e;
};

const rsi = (c, p=14) => {
    let g=0, l=0;
    for(let i=c.length-p; i<c.length; i++){
        let d = c[i]-c[i-1]; d>0 ? g+=d : l-=d;
    }
    return 100 - (100/(1+(g/l)));
};

const atr = (h, l, c, p=14) => {
    let sum = 0;
    for(let i=c.length-p; i<c.length; i++){
        sum += Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1]));
    }
    return sum/p;
};

//---------------- DATA FETCH
async function fetchData() {
    let r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol.value}&interval=${tf.value}&limit=100`);
    return await r.json();
}

//---------------- RENDERERS
function drawChart(data, p) {
    let ctx=chart.getContext("2d"); ctx.clearRect(0,0,900,300);
    let max=Math.max(...data), min=Math.min(...data), range=max-min;
    data.forEach((v,i)=>{
        let x=i*(900/data.length), y=300-((v-min)/range)*300;
        ctx.fillStyle = (i === data.length-1 && pos) ? (pos.t=="BUY"?"#22c55e":"#ef4444") : "#334155";
        ctx.fillRect(x,y,3,3);
    });
}

//---------------- MAIN LOOP
async function loop() {
    if(!run) return;

    try {
        let raw = await fetchData();
        let closes = raw.map(x=>+x[4]), highs = raw.map(x=>+x[2]), lows = raw.map(x=>+x[3]);
        let price = closes.at(-1), currentRsi = rsi(closes), currentAtr = atr(highs,lows,closes);
        
        drawChart(closes, price);

        if(!pos) {
            let ai = ((closes.at(-1) - closes.at(-10)) / (Math.max(...closes.slice(-10)) - Math.min(...closes.slice(-10)))) * 100;
            let riskAmt = (balance * (risk.value/100));
            
            // ENTRY LOGIC
            if(ai > 15 && currentRsi < 65) {
                pos = { t:"BUY", e:price, sl: price - (currentAtr * 2.5), tp: price + (currentAtr * 4), qty: riskAmt/price };
                updateLog(`LONG Entered @ ${price.toFixed(2)}`);
            } else if(ai < -15 && currentRsi > 35) {
                pos = { t:"SELL", e:price, sl: price + (currentAtr * 2.5), tp: price - (currentAtr * 4), qty: riskAmt/price };
                updateLog(`SHORT Entered @ ${price.toFixed(2)}`);
            }
            status_val.innerHTML = "SEARCHING...";
        } else {
            // TRAILING STOP & EXIT LOGIC
            let pnl = (price - pos.e) * (pos.t=="BUY"?1:-1) * pos.qty;
            
            // Trailing Stop: Move SL up if price moves in favor (for Buy)
            if(pos.t == "BUY" && price > pos.e + currentAtr) {
                let newSl = price - (currentAtr * 1.5);
                if(newSl > pos.sl) pos.sl = newSl; 
            }
            if(pos.t == "SELL" && price < pos.e - currentAtr) {
                let newSl = price + (currentAtr * 1.5);
                if(newSl < pos.sl) pos.sl = newSl;
            }

            let hitTp = pos.t=="BUY" ? price >= pos.tp : price <= pos.tp;
            let hitSl = pos.t=="BUY" ? price <= pos.sl : price >= pos.sl;

            if(hitTp || hitSl) {
                balance += pnl;
                equity.push(balance);
                pnl > 0 ? wins++ : loss++;
                updateLog(`${pnl > 0 ? 'PROFIT' : 'LOSS'} Closed: $${pnl.toFixed(2)}`);
                pos = null;
            }
            status_val.innerHTML = `IN TRADE (${pnl > 0 ? '+' : ''}${pnl.toFixed(2)})`;
        }

        // Update Panel
        bal_val.innerHTML = balance.toFixed(2);
        wr_val.innerHTML = (wins+loss > 0) ? ((wins/(wins+loss))*100).toFixed(1) : 0;
        
    } catch(e) { console.log("Connection Error"); }
    
    setTimeout(loop, 3000);
}

function updateLog(msg) { document.getElementById("log-val").innerHTML = msg; }
function start() { run = true; updateLog("Bot Started..."); loop(); }
function stop() { run = false; updateLog("Bot Stopped."); status_val.innerHTML = "IDLE"; }

let bal_val = document.getElementById("bal-val");
let wr_val = document.getElementById("wr-val");
let status_val = document.getElementById("status-val");
</script>
</body>
</html>
